     1                                 %line 1+1 fileInfo.asm
     2                                 
     3                                 
     4                                 
     5                                 
     6                                 
     7                                 
     8                                 %line 1+1 macro.inc
     9                                 
    10                                 
    11                                 
    12                                 
    13                                 
    14                                 
    15                                 
    16                                 LF equ 10
    17                                 TAB equ 9
    18                                 ESC equ 27
    19                                 SPACE equ 32
    20                                 ASTERISK equ 42
    21                                 EOL equ 0
    22                                 VAR_SIZE equ 8
    23                                 MAX_PATH equ 4096
    24                                 false equ 0
    25                                 true equ 1
    26                                 EXIT_SUCCESS equ 0
    27                                 EXIT_FAILURE equ 1
    28                                 ZERO equ 0
    29                                 ONE equ 1
    30                                 
    31                                 [default rel]
    32                                 
    33                                 [extern printf]
    34                                 %line 25+0 macro.inc
    35                                 [extern puts]
    36                                 %line 26+1 macro.inc
    37                                 [extern strcmp]
    38                                 %line 26+0 macro.inc
    39                                 [extern strcat]
    40                                 [extern strlen]
    41                                 %line 27+1 macro.inc
    42                                 [extern strncmp]
    43                                 [extern strncpy]
    44                                 %line 28+0 macro.inc
    45                                 [extern strcpy]
    46                                 %line 29+1 macro.inc
    47                                 [extern strcasecmp]
    48                                 [extern malloc]
    49                                 %line 30+0 macro.inc
    50                                 [extern free]
    51                                 %line 31+1 macro.inc
    52                                 [extern memcpy]
    53                                 %line 31+0 macro.inc
    54                                 [extern memmove]
    55                                 %line 32+1 macro.inc
    56                                 [extern chdir]
    57                                 %line 32+0 macro.inc
    58                                 [extern strncat]
    59                                 [extern getcwd]
    60                                 %line 33+1 macro.inc
    61                                 [extern lstat]
    62                                 %line 33+0 macro.inc
    63                                 [extern getpwnam]
    64                                 %line 34+1 macro.inc
    65                                 [extern opendir]
    66                                 %line 34+0 macro.inc
    67                                 [extern readdir]
    68                                 [extern closedir]
    69                                 %line 35+1 macro.inc
    70                                 [extern getpwuid]
    71                                 %line 35+0 macro.inc
    72                                 [extern getgrgid]
    73                                 %line 36+1 macro.inc
    74                                 [extern readlink]
    75                                 [extern perror]
    76                                 [extern sprintf]
    77                                 %line 38+0 macro.inc
    78                                 [extern localtime]
    79                                 %line 39+1 macro.inc
    80                                 [extern strftime]
    81                                 %line 39+0 macro.inc
    82                                 [extern asctime]
    83                                 %line 40+1 macro.inc
    84                                 
    85                                 
    86                                 %line 45+1 macro.inc
    87                                 
    88                                 %line 51+1 macro.inc
    89                                 
    90                                 %line 56+1 macro.inc
    91                                 
    92                                 %line 61+1 macro.inc
    93                                 
    94                                 %line 66+1 macro.inc
    95                                 
    96                                 
    97                                 
    98                                 
    99                                 
   100                                 
   101                                 %line 76+1 macro.inc
   102                                 
   103                                 %line 81+1 macro.inc
   104                                 
   105                                 %line 85+1 macro.inc
   106                                 
   107                                 %line 89+1 macro.inc
   108                                 
   109                                 %line 93+1 macro.inc
   110                                 
   111                                 %line 98+1 macro.inc
   112                                 
   113                                 %line 102+1 macro.inc
   114                                 
   115                                 %line 107+1 macro.inc
   116                                 
   117                                 %line 112+1 macro.inc
   118                                 
   119                                 %line 116+1 macro.inc
   120                                 
   121                                 %line 121+1 macro.inc
   122                                 
   123                                 %line 125+1 macro.inc
   124                                 
   125                                 %line 130+1 macro.inc
   126                                 
   127                                 %line 136+1 macro.inc
   128                                 
   129                                 %line 141+1 macro.inc
   130                                 
   131                                 %line 147+1 macro.inc
   132                                 
   133                                 %line 153+1 macro.inc
   134                                 
   135                                 %line 158+1 macro.inc
   136                                 
   137                                 %line 163+1 macro.inc
   138                                 
   139                                 %line 168+1 macro.inc
   140                                 
   141                                 %line 174+1 macro.inc
   142                                 
   143                                 %line 181+1 macro.inc
   144                                 
   145                                 %line 185+1 macro.inc
   146                                 
   147                                 %line 190+1 macro.inc
   148                                 
   149                                 %line 195+1 macro.inc
   150                                 
   151                                 %line 202+1 macro.inc
   152                                 
   153                                 %line 206+1 macro.inc
   154                                 
   155                                 %line 214+1 macro.inc
   156                                 
   157                                 %line 218+1 macro.inc
   158                                 
   159                                 %line 224+1 macro.inc
   160                                 
   161                                 %line 230+1 macro.inc
   162                                 
   163                                 %line 234+1 macro.inc
   164                                 
   165                                 %line 241+1 macro.inc
   166                                 
   167                                 %line 245+1 macro.inc
   168                                 
   169                                 %line 250+1 macro.inc
   170                                 
   171                                 %line 257+1 macro.inc
   172                                 
   173                                 %line 264+1 macro.inc
   174                                 
   175                                 %line 268+1 macro.inc
   176                                 
   177                                 %line 274+1 macro.inc
   178                                 
   179                                 %line 279+1 macro.inc
   180                                 
   181                                 %line 284+1 macro.inc
   182                                 
   183                                 %line 288+1 macro.inc
   184                                 
   185                                 %line 293+1 macro.inc
   186                                 
   187                                 %line 298+1 macro.inc
   188                                 
   189                                 %line 303+1 macro.inc
   190                                 
   191                                 %line 307+1 macro.inc
   192                                 
   193                                 %line 312+1 macro.inc
   194                                 
   195                                 %line 317+1 macro.inc
   196                                 
   197                                 %line 324+1 macro.inc
   198                                 
   199                                 %line 334+1 macro.inc
   200                                 
   201                                 %line 338+1 macro.inc
   202                                 
   203                                 %line 343+1 macro.inc
   204                                 
   205                                 %line 349+1 macro.inc
   206                                 
   207                                 %line 353+1 macro.inc
   208                                 
   209                                 %line 357+1 macro.inc
   210                                 
   211                                 %line 362+1 macro.inc
   212                                 
   213                                 %line 366+1 macro.inc
   214                                 
   215                                 %line 371+1 macro.inc
   216                                 
   217                                 %line 376+1 macro.inc
   218                                 
   219                                 %line 381+1 macro.inc
   220                                 
   221                                 %line 386+1 macro.inc
   222                                 
   223                                 %line 391+1 macro.inc
   224                                 
   225                                 %line 395+1 macro.inc
   226                                 
   227                                 %line 400+1 macro.inc
   228                                 
   229                                 %line 404+1 macro.inc
   230                                 
   231                                 %line 411+1 macro.inc
   232                                 
   233                                 %line 415+1 macro.inc
   234                                 
   235                                 %line 420+1 macro.inc
   236                                 
   237                                 %line 424+1 macro.inc
   238                                 
   239                                 %line 433+1 macro.inc
   240                                 
   241                                 
   242                                 %line 8+1 fileInfo.asm
   243                                 
   244                                 [global main]
   245                                 
   246                                 [extern printFileSize]
   247                                 [extern printFileTime]
   248                                 
   249                                 [global mtime]
   250                                 
   251                                 %line 22+1 fileInfo.asm
   252                                 
   253                                 %line 24+1 fileInfo.asm
   254                                 
   255                                 %line 32+1 fileInfo.asm
   256                                 
   257                                 %line 42+1 fileInfo.asm
   258                                 
   259                                 
   260                                 [section .text]
   261                                 
   262                                 printFileInfo:
   263 00000000 55                      push rbp
   264                                 %line 47+0 fileInfo.asm
   265 00000001 4889E5                  mov rbp, rsp
   266 00000004 4883E4F0                and rsp, -16
   267                                 %line 48+1 fileInfo.asm
   268                                 
   269 00000008 488D3D(F2FFFFFF)        lea rdi, [pFilePath]
   270 0000000F 488D35(F2FFFFFF)        lea rsi, [stat64]
   271 00000016 E8(F6FFFFFF)            call lstat
   272                                 %line 51+0 fileInfo.asm
   273 0000001B 85C0                    test eax, eax
   274                                 %line 52+1 fileInfo.asm
   275 0000001D 4883F8FF                cmp rax, -1
   276 00000021 0F8447020000            je .err1
   277                                 
   278 00000027 8D05(F4FFFFFF)          lea eax, dword [stat64]
   279 0000002D 83C01C                  add eax, st_uid
   280 00000030 678B30                  mov esi, dword [eax]
   281                                 
   282 00000033 488D35(F2FFFFFF)        lea rsi, qword [stat64]
   283 0000003A 4883C618                add rsi, st_mode
   284 0000003E 8B36                    mov esi, [rsi]
   285 00000040 8935(F4FFFFFF)          mov [nMode], esi
   286                                 
   287 00000046 488D3D(F2FFFFFF)        lea rdi, [stat64]
   288 0000004D 4883C71C                add rdi, st_uid
   289 00000051 488B3F                  mov rdi, [rdi]
   290 00000054 E8(F6FFFFFF)            call getpwuid
   291 00000059 488905(F2FFFFFF)        mov [pw], rax
   292                                 
   293 00000060 488D3D(F2FFFFFF)        lea rdi, [pw]
   294 00000067 488B07                  mov rax, [rdi]
   295                                 
   296 0000006A 488D3D(F2FFFFFF)        lea rdi, [stat64]
   297 00000071 4883C720                add rdi, st_gid
   298 00000075 488B3F                  mov rdi, [rdi]
   299 00000078 E8(F6FFFFFF)            call getgrgid
   300 0000007D 488905(F2FFFFFF)        mov [gr], rax
   301                                 
   302 00000084 488D3D(F2FFFFFF)        lea rdi, [sUid]
   303 0000008B 488B35(F2FFFFFF)        mov rsi, [pw]
   304 00000092 488B36                  mov rsi, [rsi]
   305 00000095 E8(F6FFFFFF)            call strcpy
   306                                 
   307 0000009A 488D3D(F2FFFFFF)        lea rdi, [sGid]
   308 000000A1 488B35(F2FFFFFF)        mov rsi, [gr]
   309 000000A8 488B36                  mov rsi, [rsi]
   310 000000AB E8(F6FFFFFF)            call strcpy
   311                                 
   312 000000B0 488D3D(F2FFFFFF)        lea rdi, [stat64]
   313 000000B7 4883C710                add rdi, st_nlink
   314 000000BB 488B3F                  mov rdi, [rdi]
   315 000000BE 48893D(F2FFFFFF)        mov [nFileSize], rdi
   316                                 
   317 000000C5 488D3D(F2FFFFFF)        lea rdi, [stat64]
   318 000000CC 4883C710                add rdi, st_nlink
   319 000000D0 488B3F                  mov rdi, [rdi]
   320 000000D3 48893D(F2FFFFFF)        mov [nHardLinks], rdi
   321                                 
   322 000000DA 488D3D(F2FFFFFF)        lea rdi, [stat64]
   323 000000E1 4883C730                add rdi, st_size
   324 000000E5 488B3F                  mov rdi, [rdi]
   325 000000E8 48893D(F2FFFFFF)        mov [nFileSize], rdi
   326                                 
   327 000000EF 488D3D(F2FFFFFF)        lea rdi, [stat64]
   328 000000F6 4883C748                add rdi, st_mtime
   329 000000FA 488B3F                  mov rdi, [rdi]
   330 000000FD 48893D(F2FFFFFF)        mov [mtime], rdi
   331                                 
   332 00000104 8B05(F4FFFFFF)          mov eax, [nMode]
   333 0000010A 2500F00000              and eax, 0170000
   334                                 
   335 0000010F 483D00800000            cmp rax, 0100000
   336 00000115 745F                    je .gotFileType
   337                                 
   338 00000117 483D00400000            cmp rax, 0040000
   339 0000011D C605(F2FFFFFF)64        mov byte [perm], 'd'
   340 00000124 7450                    je .gotFileType
   341                                 
   342 00000126 483D00A00000            cmp rax, 0120000
   343 0000012C C605(F2FFFFFF)6C        mov byte [perm], 'l'
   344 00000133 7441                    je .gotFileType
   345                                 
   346 00000135 483D00100000            cmp rax, 0010000
   347 0000013B C605(F2FFFFFF)70        mov byte [perm], 'p'
   348 00000142 7432                    je .gotFileType
   349                                 
   350 00000144 483D00C00000            cmp rax, 0140000
   351 0000014A C605(F2FFFFFF)73        mov byte [perm], 's'
   352 00000151 7423                    je .gotFileType
   353                                 
   354 00000153 483D00600000            cmp rax, 0060000
   355 00000159 C605(F2FFFFFF)62        mov byte [perm], 'b'
   356 00000160 7414                    je .gotFileType
   357                                 
   358 00000162 483D00200000            cmp rax, 0020000
   359 00000168 C605(F2FFFFFF)63        mov byte [perm], 'c'
   360 0000016F 7405                    je .gotFileType
   361                                 
   362 00000171 C605(F2FFFFFF)3F        mov byte [perm], '?'
   363                                 
   364                                 .gotFileType:
   365 00000178 8B05(F4FFFFFF)          mov eax, [nMode]
   366 0000017E A900010000              test eax, 0400
   367 00000183 7405                    jz .gotUserRead
   368 00000185 C605(F3FFFFFF)72        mov byte [perm + 1], 'r'
   369                                 
   370                                 .gotUserRead:
   371 0000018C A980000000              test eax, 0200
   372 00000191 7405                    jz .gotUserWrite
   373 00000193 C605(F4FFFFFF)77        mov byte [perm + 2], 'w'
   374                                 
   375                                 .gotUserWrite:
   376 0000019A A940000000              test eax, 0100
   377 0000019F 7405                    jz .gotUserExecute
   378 000001A1 C605(F5FFFFFF)78        mov byte [perm + 3], 'x'
   379                                 
   380                                 .gotUserExecute:
   381 000001A8 A920000000              test eax, 0040
   382 000001AD 7405                    jz .gotGroupRead
   383 000001AF C605(F6FFFFFF)72        mov byte [perm + 4], 'r'
   384                                 
   385                                 .gotGroupRead:
   386 000001B6 A910000000              test eax, 0020
   387 000001BB 7405                    jz .gotGroupWrite
   388 000001BD C605(F7FFFFFF)77        mov byte [perm + 5], 'w'
   389                                 
   390                                 .gotGroupWrite:
   391 000001C4 A908000000              test eax, 0010
   392 000001C9 7405                    jz .gotGroupExecute
   393 000001CB C605(F8FFFFFF)78        mov byte [perm + 6], 'x'
   394                                 
   395                                 .gotGroupExecute:
   396 000001D2 A904000000              test eax, 0004
   397 000001D7 7405                    jz .gotOtherRead
   398 000001D9 C605(F9FFFFFF)72        mov byte [perm + 7], 'r'
   399                                 
   400                                 .gotOtherRead:
   401 000001E0 A902000000              test eax, 0002
   402 000001E5 7405                    jz .gotOtherWrite
   403 000001E7 C605(FAFFFFFF)77        mov byte [perm + 8], 'w'
   404                                 
   405                                 .gotOtherWrite:
   406 000001EE A901000000              test eax, 0001
   407 000001F3 7405                    jz .printPermissions
   408 000001F5 C605(FBFFFFFF)78        mov byte [perm + 9], 'x'
   409                                 
   410                                 .printPermissions:
   411 000001FC 803D(F2FFFFFF)6C        cmp byte [perm], 'l'
   412 00000203 751D                    jne .next
   413                                 
   414 00000205 488D3D(F2FFFFFF)        lea rdi, [pFilePath]
   415                                 %line 191+0 fileInfo.asm
   416 0000020C 488D35(F2FFFFFF)        lea rsi, [pBuffer2]
   417 00000213 48C7C240000000          mov rdx, 64
   418 0000021A E8(F6FFFFFF)            call readlink
   419                                 %line 192+1 fileInfo.asm
   420 0000021F 83F8FF                  cmp eax, -1
   421 00000222 745C                    je .err2
   422                                 
   423                                 .next:
   424 00000224 488D3D(F2FFFFFF)        lea rdi, [begItemFmt]
   425 0000022B 488D35(F2FFFFFF)        lea rsi, [perm]
   426 00000232 488B15(F2FFFFFF)        mov rdx, [nHardLinks]
   427 00000239 488D0D(F2FFFFFF)        lea rcx, [sUid]
   428 00000240 4C8D05(F2FFFFFF)        lea r8, [sGid]
   429 00000247 31C0                    xor eax, eax
   430                                 %line 201+0 fileInfo.asm
   431 00000249 E8(F6FFFFFF)            call printf
   432                                 %line 202+1 fileInfo.asm
   433                                 
   434 0000024E 488B3D(F2FFFFFF)        mov rdi, [nFileSize]
   435 00000255 E8(F6FFFFFF)            call printFileSize
   436                                 
   437 0000025A 488D3D(F2FFFFFF)        lea rdi, [mtime]
   438 00000261 E8(F6FFFFFF)            call printFileTime
   439                                 
   440 00000266 488D3D(F2FFFFFF)        lea rdi, [pFilePath]
   441                                 %line 209+0 fileInfo.asm
   442 0000026D E8(F6FFFFFF)            call puts
   443                                 %line 210+1 fileInfo.asm
   444 00000272 EB1A                    jmp .fin
   445                                 
   446                                 .err1:
   447 00000274 488D3D(F2FFFFFF)        lea rdi, [lstatName]
   448                                 %line 213+0 fileInfo.asm
   449 0000027B E8(F6FFFFFF)            call perror
   450                                 %line 214+1 fileInfo.asm
   451 00000280 EB0E                    jmp .exit
   452                                 
   453                                 .err2:
   454 00000282 488D3D(F2FFFFFF)        lea rdi, [rdlinkName]
   455                                 %line 217+0 fileInfo.asm
   456 00000289 E8(F6FFFFFF)            call perror
   457                                 %line 218+1 fileInfo.asm
   458 0000028E EB00                    jmp .exit
   459                                 
   460                                 .fin:
   461 00000290 31C0                    xor eax, eax
   462                                 
   463                                 .exit:
   464 00000292 C9                      leave
   465                                 %line 224+0 fileInfo.asm
   466 00000293 C3                      ret
   467                                 %line 225+1 fileInfo.asm
   468                                 
   469                                 
   470                                 main:
   471 00000294 55                      push rbp
   472                                 %line 228+0 fileInfo.asm
   473 00000295 4889E5                  mov rbp, rsp
   474 00000298 4883E4F0                and rsp, -16
   475                                 %line 229+1 fileInfo.asm
   476 0000029C 488D3D(F2FFFFFF)        lea rdi, [pFilePath]
   477 000002A3 E853FDFFFF              call printFileInfo
   478                                 
   479                                 .fin:
   480 000002A8 C9                      leave
   481                                 %line 233+0 fileInfo.asm
   482 000002A9 C3                      ret
   483                                 %line 234+1 fileInfo.asm
   484                                 
   485                                 
   486                                 [section .bss]
   487                                 
   488                                 [absolute 0]
   489                                 %line 238+0 fileInfo.asm
   490                                 stat64_struct:
   491                                 %line 239+1 fileInfo.asm
   492                                  st_dev resq 1
   493                                  st_ino resq 1
   494                                  st_nlink resq 1
   495                                  st_mode resd 1
   496                                  st_uid resd 1
   497                                  st_gid resd 1
   498                                  st_fill1 resd 1
   499                                  st_rdev resq 1
   500                                  st_size resq 1
   501                                  st_blksize resq 1
   502                                  st_blocks resq 1
   503                                  st_mtime resq 1
   504                                  st_atime resq 1
   505                                  st_ctime resq 1
   506                                 stat64_struct_size EQU $ - stat64_struct
   507                                 %line 253+0 fileInfo.asm
   508                                 [section .bss]
   509                                 %line 254+1 fileInfo.asm
   510                                 
   511                                 [absolute 0]
   512                                 %line 255+0 fileInfo.asm
   513                                 pw_struct:
   514                                 %line 256+1 fileInfo.asm
   515                                  pw_name resq 1
   516                                  pw_passwd resq 1
   517                                  pw_uid resd 1
   518                                  pw_gid resd 1
   519                                  pw_gecos resq 1
   520                                  pw_dir resq 1
   521                                  pw_shell resq 1
   522                                 pw_struct_size EQU $ - pw_struct
   523                                 %line 263+0 fileInfo.asm
   524                                 [section .bss]
   525                                 %line 264+1 fileInfo.asm
   526                                 
   527                                 [absolute 0]
   528                                 %line 265+0 fileInfo.asm
   529                                 gr_struct:
   530                                 %line 266+1 fileInfo.asm
   531                                  gr_name resq 1
   532                                  gr_passwd resq 1
   533                                  gr_gid resd 1
   534                                  gr_mem resb 100
   535                                 gr_struct_size EQU $ - gr_struct
   536                                 %line 270+0 fileInfo.asm
   537                                 [section .bss]
   538                                 %line 271+1 fileInfo.asm
   539                                 
   540 00000000 <gap>                  mtime resq 1
   541 00000008 <gap>                  buffer resb 40
   542 00000030 <gap>                  sUid resb 40
   543 00000058 <gap>                  sGid resb 40
   544 00000080 <gap>                  nFileSize resq 1
   545 00000088 <gap>                  nMode resd 1
   546                                 
   547                                 [section .data]
   548                                 
   549 00000000 48617264206C696E6B-    hardlinkFmt db "Hard links: %ld", LF, EOL
   550 00000000 733A20256C640A00   
   551 00000011 7569643A2025642067-    uidgidFmt db "uid: %d gid: %d", LF, EOL
   552 00000011 69643A2025640A00   
   553 00000022 0000000000000000       nHardLinks dq 0
   554 0000002A 46696C652073697A65-    sizeBufferFmt_0 db "File size: %ld", LF, EOL
   555 0000002A 3A20256C640A00     
   556 0000003A 257300                 bufFmt db "%s", EOL
   557 0000003D 252E316600             sizeBufFmt db "%.1f", EOL
   558 00000042 256C640A00             fileSizeFmt db "%ld", LF, EOL
   559                                 
   560 00000047 2D2D2D2D2D2D2D2D2D-    perm db '-', '-', '-', '-', '-', '-', '-', '-', '-', '-', ' ', EOL
   561 00000047 2D2000             
   562 00000053 2573256C6420257320-    begItemFmt db "%s%ld %s %s ", EOL
   563 00000053 25732000           
   564 00000060 25730A00               endItemFmt db "%s", LF, EOL
   565                                 
   566                                 stat64 :
   567                                 %line 293+0 fileInfo.asm
   568                                 ..@53.strucstart:
   569                                 %line 294+1 fileInfo.asm
   570 00000064 00<rept>               times stat64_struct_size-($-..@53.strucstart) db 0
   571                                 
   572                                 pw :
   573                                 %line 296+0 fileInfo.asm
   574                                 ..@56.strucstart:
   575                                 %line 297+1 fileInfo.asm
   576 000000C4 00<rept>               times pw_struct_size-($-..@56.strucstart) db 0
   577                                 
   578                                 gr :
   579                                 %line 299+0 fileInfo.asm
   580                                 ..@59.strucstart:
   581                                 %line 300+1 fileInfo.asm
   582 000000F4 00<rept>               times gr_struct_size-($-..@59.strucstart) db 0
   583                                 
   584 0000016C 6C7374617420726574-    lstatName db "lstat returned", EOL
   585 0000016C 75726E656400       
   586 0000017B 72646C696E6B207265-    rdlinkName db "rdlink returned", EOL
   587 0000017B 7475726E656400     
   588 0000018B 74686545786500         pFilePath db "theExe", EOL
   589 00000192 202D3E2025732000       pBuffer1 db " -> %s ", EOL
   590 0000019A 202020202020202020-    pBuffer2 db "                                                   ", EOL
   591 0000019A 202020202020202020-
   592 0000019A 202020202020202020-
   593 0000019A 202020202020202020-
   594 0000019A 202020202020202020-
   595 0000019A 20202020202000     
   596                                 
   597                                 
